# Argentina News Bot

## Описание проекта

Argentina News Bot - это Telegram-бот, который автоматически мониторит выбранные источники (группы, каналы, пользователей) на предмет новостей, связанных с Аргентиной. Бот фильтрует сообщения, обрабатывает их с помощью Mistral AI для создания кратких и информативных резюме, а затем публикует результаты в целевую группу или канал.

## Основные возможности

- Мониторинг нескольких источников новостей в Telegram
- Автоматическая фильтрация контента, связанного с Аргентиной
- Обработка и резюмирование новостей с помощью Mistral AI
- Публикация обработанных новостей в целевую группу/канал
- Поддержка медиафайлов (фото, видео)
- Форматирование сообщений с использованием Markdown
- Тестовый режим для проверки функциональности

## Требования

- Python 3.7+
- Telegram API ключи (API_ID и API_HASH)
- Mistral AI API ключи
- Доступ к исходным и целевым группам/каналам в Telegram

## Установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/AlikOsta/tg_news_bot.git
cd tg_news_bot
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` в корневой директории проекта со следующим содержимым:
```
API_ID=ваш_telegram_api_id
API_HASH=ваш_telegram_api_hash
SOURCE_GROUPS=id_группы_1,id_группы_2,username_канала
TARGET_GROUP=id_целевой_группы
MISTRAL_API_KEY=ваш_mistral_api_key
MISTRAL_API_KEY_FILTER=ваш_mistral_api_key_для_фильтрации

# Промпт для фильтрации контента
FILTER_PROMPT="Оцени, связан ли следующий текст с Аргентиной или темами, имеющими прямое отношение к Аргентине (например, аргентинская политика, экономика, культура, спорт, иммиграция в Аргентину, жизнь в Аргентине и т.д.). Ответь только \"ДА\" если текст связан с Аргентиной, или \"НЕТ\" если не связан. Текст для анализа: {text}"

# Промпт для обработки контента
CONTENT_PROMPT="Представь, что ты опытный новостной редактор. Твоя задача – на основе предоставленной статьи создать краткую, но информативную версию (до 1000 символов) на русском языке. Текст должен быть четким, интересным и передавать суть оригинальной статьи. Требования: Добавь к тексту заголовок статьи. Сохрани ключевые факты и основную мысль. Перевести текст на русский язык. Убери лишние детали, делая текст лаконичным. Текс сатьи не должен содержать какой-либо рекламы на сервисы, продукты, аккаунты или людей. НЕ ИСПОЬЗУЙ ссылки на сайты или другие статьи.(ВАЖНО!!!) Длина итогового текста не должна превышать 800 символов.(ВАЖНО!!!) В СТАТЬЕ НЕ ДОЛЖНО БЫТЬ ССЫЛОК на источник. Исходная статья: Заголовок: {title} Текст статьи: {article_content}"

# Настройки моделей Mistral AI
FILTER_MODEL="mistral-large-latest"
CONTENT_MODEL="mistral-large-latest"

# Максимальное количество токенов для ответов
FILTER_MAX_TOKENS=10
CONTENT_MAX_TOKENS=800
```

## Структура проекта

- `bot.py` - основной файл бота, содержащий логику мониторинга и обработки сообщений
- `mistral_api.py` - модуль для взаимодействия с Mistral AI API для обработки контента
- `mistral_filter.py` - модуль для фильтрации контента, связанного с Аргентиной
- `run_bot.py` - скрипт для запуска бота
- `test_bot.py` - скрипт для тестирования различных функций бота
- `check_dialogs.py` - утилита для получения ID групп и каналов
- `temp_media/` - временная директория для хранения медиафайлов
- `test_media/` - директория для тестовых медиафайлов

## Запуск бота

### Основной режим

Для запуска бота в основном режиме выполните:
```bash
python run_bot.py
```

### Тестовый режим

Для тестирования функциональности бота выполните:
```bash
python test_bot.py
```

Тестовый режим предлагает следующие опции:
1. Тест функции фильтрации
2. Тест обработки контента
3. Тест полного процесса
4. Тест публикации новости в целевую группу
5. Запуск всех тестов

### Получение ID групп и каналов

Для получения ID групп и каналов, к которым у вас есть доступ, выполните:
```bash
python check_dialogs.py
```

## Принцип работы

1. Бот подключается к указанным в настройках исходным группам/каналам
2. При появлении нового сообщения, бот проверяет его на релевантность к Аргентине
3. Если сообщение релевантно, оно обрабатывается с помощью Mistral AI для создания краткого резюме
4. Обработанное сообщение форматируется с использованием Markdown
5. Если сообщение содержит медиафайлы, они также загружаются
6. Готовое сообщение публикуется в целевую группу/канал
7. Временные медиафайлы удаляются после публикации

## Обработка ошибок

Бот включает в себя механизмы обработки различных ошибок:
- Повторные попытки с экспоненциальной задержкой при ошибках API
- Логирование всех действий и ошибок
- Безопасное получение сущностей Telegram
- Гарантированная очистка временных файлов

## Логирование

Логи работы бота сохраняются в файлы:
- `bot_log.txt` - для основного режима
- `test_log.txt` - для тестового режима

## Настройка

### Фильтрация и обработка контента

Все настройки фильтрации и обработки контента можно изменить в файле `.env`:

- `FILTER_PROMPT` - промпт для определения релевантности контента к Аргентине
- `CONTENT_PROMPT` - промпт для обработки и резюмирования контента
- `FILTER_MODEL` и `CONTENT_MODEL` - модели Mistral AI для фильтрации и обработки
- `FILTER_MAX_TOKENS` и `CONTENT_MAX_TOKENS` - максимальное количество токенов для ответов

### Источники и целевые группы

В файле `.env` можно настроить:
- `SOURCE_GROUPS` - список исходных групп/каналов для мониторинга (через запятую)
- `TARGET_GROUP` - ID целевой группы/канала для публикации обработанных новостей

## Тестирование с медиафайлами

Для тестирования публикации с медиафайлами:
1. Создайте папку `test_media/` и поместите в неё тестовые изображения
2. Запустите `test_bot.py` и выберите опцию тестирования публикации
3. При публикации выберите опцию добавления медиафайла

## Лицензия

Этот проект распространяется под лицензией MIT. См. файл LICENSE для получения дополнительной информации.

## Авторы

- [AlikOsta](https://github.com/AlikOsta)

## Поддержка

Если у вас возникли проблемы или вопросы, создайте issue в репозитории проекта.

---

**Примечание**: Для работы бота требуются действительные ключи API Telegram и Mistral AI. Убедитесь, что вы получили их перед запуском бота.
